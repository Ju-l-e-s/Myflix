services:
  # L'orchestrateur de maintenance (Bot Go Architect)
  maintenance:
    build: ../../scripts
    container_name: maintenance
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Paris}
      - DOCKER_MODE=true
      - REAL_IP=${REAL_IP}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - RADARR_API_KEY=${RADARR_API_KEY}
      - TMDB_API_KEY=${TMDB_API_KEY}
      - SONARR_API_KEY=${SONARR_API_KEY}
      - GEMINI_KEY=${GEMINI_KEY}
      - SHARE_DOMAIN=${SHARE_DOMAIN}
      - STORAGE_NVME_PATH=/data/internal
      - STORAGE_HDD_PATH=/data/external
    volumes:
      - ${MEDIA_SHARE_PATH:-/home/jules/media_share}:/media_share
      - ${NVME_DATA_PATH:-./data}:/data/internal
      - ${HDD_STORAGE_PATH:-/mnt/externe}:/data/external
      # --- Legacy Bridge ---
      - ${NVME_DATA_PATH:-./data}/media/movies:/movies
      - ${NVME_DATA_PATH:-./data}/media/tv:/tv
      - ${HDD_STORAGE_PATH:-/mnt/externe}:/mnt/externe
      - ${NVME_DATA_PATH:-./data}/gluetun:/tmp/gluetun:ro
      - /var/run/docker.sock:/var/run/docker.sock # Privilège Auto-Healing
    ports:
      - 127.0.0.1:5001:5001
      - 127.0.0.1:3001:3000 # Changé pour éviter le conflit avec Grafana (3000)
      - 127.0.0.1:8001:8001
    restart: always
    networks: [arr_network, npm-nw]

  # Sauvegarde automatisée
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Paris}
    volumes:
      - ${NVME_DATA_PATH:-./data}/duplicati/config:/config
      - ${DOCKER_BASE_DIR:-/home/jules}/infra:/source/infra:ro
      - ${DOCKER_BASE_DIR:-/home/jules}/scripts:/source/scripts:ro
      - ${NVME_DATA_PATH:-./data}/duplicati/backups:/backups
    ports:
      - 127.0.0.1:8200:8200
    restart: unless-stopped
    networks: [arr_network, npm-nw]

  # VPN & Torrent
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add: [NET_ADMIN]
    devices: [/dev/net/tun:/dev/net/tun]
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER:-nordvpn}
      - VPN_TYPE=${VPN_TYPE:-openvpn}
      - OPENVPN_USER=${NORDVPN_USER}
      - OPENVPN_PASSWORD=${NORDVPN_PASS}
      - SERVER_COUNTRIES=${VPN_COUNTRY:-Netherlands}
      - SERVER_CATEGORIES=p2p
      - LOCAL_NETWORK=192.168.1.0/24,172.18.0.0/16,172.23.0.0/16
      - FIREWALL=on
      - FIREWALL_VPN_INPUT_PORTS=6881
      - BLOCK_IPV6=on
      - VPN_MTU=1400
      - DNS_ADDRESS=1.1.1.1
      - DNS_UPSTREAM_RESOLVERS=cloudflare
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
    volumes:
      - ${NVME_DATA_PATH:-./data}/gluetun:/tmp/gluetun
    ports:
      - 127.0.0.1:8090:8080 # qBittorrent WebUI
      - 6881:6881
      - 6881:6881/udp
    restart: always
    networks: [arr_network, npm-nw]

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on: [gluetun]
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Paris}
      - WEBUI_PORT=8080
    volumes:
      - ${NVME_DATA_PATH:-./data}/qbittorrent/config:/config
      - ${NVME_DATA_PATH:-./data}:/data/internal
      - ${NVME_DATA_PATH:-./data}/downloads:/downloads
    restart: always

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    ports: [127.0.0.1:8191:8191]
    restart: unless-stopped
    networks: [arr_network, npm-nw]

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    environment: 
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - VERSION=docker
    volumes:
      - ${NVME_DATA_PATH:-./data}/plex/config:/config
      - ${NVME_DATA_PATH:-./data}:/data/internal
      - ${HDD_STORAGE_PATH:-/mnt/externe}:/data/external
      # --- Legacy Bridge ---
      - ${NVME_DATA_PATH:-./data}/media/movies:/movies
      - ${NVME_DATA_PATH:-./data}/media/tv:/tv
      - ${HDD_STORAGE_PATH:-/mnt/externe}:/mnt/externe
    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 15 4 * * *
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=generic+https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?format=HTML&notification=true
    restart: unless-stopped

networks:
  arr_network:
    driver: bridge
  npm-nw:
    external: true
